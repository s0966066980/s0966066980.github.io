<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šå¤©åƒä»€éº¼ï¼Ÿv2.1 (ä¿®å¾©ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F3F4F6;
            -webkit-tap-highlight-color: transparent;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #F59E0B;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card-anim {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-anim:active {
            transform: scale(0.98);
        }
        /* Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #F97316;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #ddd;
            border-radius: 2px;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white shadow-sm z-10 px-4 py-3 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-utensils text-orange-500 mr-2"></i>ä»Šå¤©åƒä»€éº¼</h1>
            <p class="text-xs text-gray-500">Hi æ™¨æ™¨ï¼Œ<span id="date-display"></span></p>
        </div>
        <div class="flex gap-3">
            <button onclick="openHistory()" class="bg-gray-100 p-2 rounded-full text-gray-600 hover:bg-gray-200 transition relative">
                <i class="fa-solid fa-clock-rotate-left"></i>
            </button>
            <div id="status-badge" class="hidden px-2 py-1 rounded-full text-xs font-semibold bg-gray-200 text-gray-600 flex items-center">
                å®šä½ä¸­...
            </div>
        </div>
    </header>

    <!-- Controls -->
    <div class="bg-white border-b border-gray-200 pb-2">
        <div class="px-4 py-2">
            <div class="flex justify-between text-xs text-gray-500 mb-1">
                <span>æœå°‹ç¯„åœ</span>
                <span id="range-value" class="font-bold text-orange-600">500 å…¬å°º</span>
            </div>
            <input type="range" id="distance-range" min="100" max="1000" step="100" value="500" class="w-full">
        </div>

        <div class="px-4 flex gap-2 overflow-x-auto whitespace-nowrap scrollbar-hide pb-2">
            <button onclick="setMode('all')" id="btn-all" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-orange-500 text-white shadow-md transition">
                å…¨éƒ¨é¤å»³
            </button>
            <button onclick="setMode('date')" id="btn-date" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition">
                ğŸ’• æ£ æ£ ç´„æœƒ
            </button>
            <button onclick="setMode('drinks')" id="btn-drinks" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition">
                ğŸ¥¤ æ‰‹æ–é£²
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-4 relative" id="main-container">
        <!-- Start Screen -->
        <div id="start-screen" class="flex flex-col items-center justify-center h-full text-center space-y-6 pt-10">
            <div class="relative">
                <div class="w-32 h-32 bg-orange-100 rounded-full flex items-center justify-center animate-bounce">
                    <i class="fa-solid fa-location-dot text-5xl text-orange-500"></i>
                </div>
                <div class="absolute top-0 left-0 w-32 h-32 bg-orange-400 rounded-full opacity-20 animate-ping"></div>
            </div>
            <div>
                <h2 class="text-xl font-bold text-gray-800">æœå°‹é™„è¿‘çš„ç¾å‘³</h2>
                <p class="text-gray-500 mt-2 text-sm px-8">æ™¨æ™¨å¹«ä½ æ‰¾å‘¨åœ <span id="start-range-text">500</span> å…¬å°ºå…§çš„åº—å®¶</p>
            </div>
            <button onclick="getLocation()" class="bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold py-3 px-10 rounded-xl shadow-lg transform transition hover:scale-105 active:scale-95 flex items-center text-lg">
                <i class="fa-solid fa-magnifying-glass-location mr-2"></i> é–‹å§‹æœå°‹
            </button>
        </div>

        <!-- Loading -->
        <div id="loading-screen" class="hidden flex flex-col items-center justify-center h-full pt-20">
            <div class="loader mb-4"></div>
            <p class="text-gray-600 font-medium">æ­£åœ¨æƒæå‘¨åœåº—å®¶...</p>
            <p class="text-gray-400 text-xs mt-2">ç¯„åœï¼š<span id="loading-range-text"></span> å…¬å°º</p>
        </div>

        <!-- Results -->
        <div id="results-list" class="hidden pb-24 space-y-3"></div>
    </main>

    <!-- FAB -->
    <div id="fab-container" class="hidden absolute bottom-6 right-6 z-20">
        <button onclick="pickRandom()" class="bg-gray-800 text-white w-16 h-16 rounded-full shadow-xl flex items-center justify-center text-2xl hover:bg-gray-700 transition transform hover:rotate-12 active:scale-90">
            <i class="fa-solid fa-dice"></i>
        </button>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl transform transition-all scale-95 opacity-0" id="modal-content">
            <div class="text-center relative">
                <button onclick="closeModal()" class="absolute -top-2 -right-2 text-gray-400 p-2"><i class="fa-solid fa-xmark"></i></button>
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-check text-2xl text-green-600"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-400 mb-1">æ±ºå®šå°±æ˜¯é€™å®¶äº†ï¼</h3>
                <h2 id="modal-shop-name" class="text-2xl font-black text-gray-800 mb-2 leading-tight">åº—å®¶åç¨±</h2>
                <p id="modal-shop-type" class="text-sm text-gray-500 mb-6 bg-gray-100 inline-block px-3 py-1 rounded-full">é¡å‹</p>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="saveToHistoryAndClose()" class="col-span-2 py-2 bg-yellow-100 text-yellow-700 rounded-xl font-bold hover:bg-yellow-200 transition border border-yellow-200 mb-1">
                        <i class="fa-solid fa-bookmark mr-1"></i> ç´€éŒ„ï¼šæˆ‘åƒé€™å®¶
                    </button>
                    <button onclick="pickRandom()" class="py-3 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition">
                        å†é¸ä¸€æ¬¡
                    </button>
                    <button onclick="openGoogleMapsFromModal()" class="py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700 transition flex items-center justify-center">
                        <i class="fa-solid fa-diamond-turn-right mr-2"></i> å»å°èˆª
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="fixed inset-0 bg-white z-50 hidden flex flex-col transition-transform duration-300 translate-y-full">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
            <h2 class="text-lg font-bold text-gray-800"><i class="fa-solid fa-book-open text-orange-500 mr-2"></i>åƒè²¨ç´€éŒ„</h2>
            <button onclick="closeHistory()" class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4" id="history-list"></div>
        <div class="p-4 border-t border-gray-200 bg-white text-center">
            <button onclick="clearHistory()" class="text-red-500 text-sm font-medium">æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="error-msg" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 bg-red-100 text-red-700 px-4 py-2 rounded-lg shadow-md text-sm whitespace-nowrap z-50">
        <i class="fa-solid fa-circle-exclamation mr-1"></i> <span id="error-text">ç™¼ç”ŸéŒ¯èª¤</span>
    </div>

    <script>
        // --- State Variables ---
        let currentUserLocation = null;
        let shopsData = [];
        let currentMode = 'all'; 
        let selectedShop = null;
        let currentRadius = 500;
        let historyData = JSON.parse(localStorage.getItem('foodHistory')) || [];

        // --- DOM Elements ---
        const statusBadge = document.getElementById('status-badge');
        const startScreen = document.getElementById('start-screen');
        const loadingScreen = document.getElementById('loading-screen');
        const resultsList = document.getElementById('results-list');
        const fabContainer = document.getElementById('fab-container');
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');
        const historyModal = document.getElementById('history-modal');
        const rangeInput = document.getElementById('distance-range');
        const rangeValue = document.getElementById('range-value');

        // --- Init ---
        document.getElementById('date-display').innerText = new Date().toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'short' });

        // --- Event Listeners ---
        rangeInput.addEventListener('input', (e) => {
            currentRadius = e.target.value;
            const text = currentRadius >= 1000 ? (currentRadius/1000) + " å…¬é‡Œ" : currentRadius + " å…¬å°º";
            rangeValue.innerText = text;
            document.getElementById('start-range-text').innerText = currentRadius;
        });

        rangeInput.addEventListener('change', () => {
            if (currentUserLocation) {
                fetchShops(currentUserLocation.lat, currentUserLocation.lng);
            }
        });

        // --- Configuration (UPDATED for better Handshake drinks support) ---
        // Using a function that returns the QL snippet directly with coordinates inserted
        const modes = {
            'all': {
                color: 'bg-orange-500',
                generateQL: (lat, lng, r) => `
                    node(around:${r},${lat},${lng})["amenity"~"restaurant|fast_food|food_court"];
                    way(around:${r},${lat},${lng})["amenity"~"restaurant|fast_food|food_court"];
                `
            },
            'date': {
                color: 'bg-pink-500',
                generateQL: (lat, lng, r) => `
                    node(around:${r},${lat},${lng})["amenity"~"cafe|ice_cream"];
                    way(around:${r},${lat},${lng})["amenity"~"cafe|ice_cream"];
                `
            },
            'drinks': {
                color: 'bg-teal-600',
                // Updated Query: More robust for Taiwan Bubble Tea shops
                // Searches for cuisine=bubble_tea OR shop=tea/beverage OR names containing tea/drink keywords
                generateQL: (lat, lng, r) => `
                    (
                      node(around:${r},${lat},${lng})["cuisine"="bubble_tea"];
                      node(around:${r},${lat},${lng})["shop"~"tea|beverage"];
                      node(around:${r},${lat},${lng})["name"~"èŒ¶|é£²|Tea|Coffee"];
                      way(around:${r},${lat},${lng})["cuisine"="bubble_tea"];
                      way(around:${r},${lat},${lng})["shop"~"tea|beverage"];
                    );
                `
            }
        };

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.className = "filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition";
            });
            const activeBtn = document.getElementById(`btn-${mode}`);
            activeBtn.classList.remove('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
            activeBtn.classList.add(modes[mode].color, 'text-white', 'shadow-md');

            if (currentUserLocation) {
                fetchShops(currentUserLocation.lat, currentUserLocation.lng);
            }
        }

        function getLocation() {
            if (!navigator.geolocation) {
                showError("ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½");
                return;
            }
            statusBadge.classList.remove('hidden');
            statusBadge.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> å®šä½ä¸­...';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentUserLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    statusBadge.innerHTML = '<i class="fa-solid fa-location-arrow text-green-600 mr-1"></i> å®šä½æˆåŠŸ';
                    statusBadge.classList.add('bg-green-100', 'text-green-800');
                    fetchShops(currentUserLocation.lat, currentUserLocation.lng);
                },
                (error) => {
                    let msg = "ç„¡æ³•ç²å–ä½ç½®";
                    if (error.code === 1) msg = "è«‹å…è¨±ä½ç½®å­˜å–æ¬Šé™";
                    showError(msg);
                    statusBadge.innerHTML = 'å®šä½å¤±æ•—';
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        async function fetchShops(lat, lng) {
            startScreen.classList.add('hidden');
            loadingScreen.classList.remove('hidden');
            document.getElementById('loading-range-text').innerText = currentRadius;
            resultsList.classList.add('hidden');
            fabContainer.classList.add('hidden');

            try {
                // Generate the specific query part based on mode and location
                const qlSnippet = modes[currentMode].generateQL(lat, lng, currentRadius);

                const finalQuery = `
                    [out:json][timeout:25];
                    (
                      ${qlSnippet}
                    );
                    out center;
                `;

                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: finalQuery
                });

                if (!response.ok) throw new Error("API Error");
                const data = await response.json();
                processResults(data.elements);

            } catch (err) {
                console.error("Fetch Error:", err);
                showError("ç„¡æ³•å–å¾—åº—å®¶è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦");
                loadingScreen.classList.add('hidden');
                startScreen.classList.remove('hidden');
            }
        }

        function processResults(elements) {
            const uniqueIds = new Set();
            
            shopsData = elements.filter(el => {
                if (!el.tags || !el.tags.name) return false;
                if (uniqueIds.has(el.tags.name)) return false; 
                
                // Extra filtering for "Drinks" mode to remove non-drink places that might match "Coffee"
                // e.g. We want to avoid full restaurants if possible, but keep it simple for now.
                
                uniqueIds.add(el.tags.name);
                return true;
            }).map(el => {
                const lat = el.lat || el.center.lat;
                const lon = el.lon || el.center.lon;
                const dist = getDistanceFromLatLonInKm(currentUserLocation.lat, currentUserLocation.lng, lat, lon);
                return {
                    id: el.id,
                    name: el.tags.name,
                    type: el.tags.cuisine || el.tags.shop || el.tags.amenity || 'åº—å®¶',
                    lat: lat,
                    lon: lon,
                    distance: dist.toFixed(2),
                    distanceM: Math.round(dist * 1000),
                    tags: el.tags
                };
            }).sort((a, b) => a.distance - b.distance);

            renderList();
        }

        function renderList() {
            loadingScreen.classList.add('hidden');
            resultsList.classList.remove('hidden');
            resultsList.innerHTML = '';

            if (shopsData.length === 0) {
                resultsList.innerHTML = `
                    <div class="text-center mt-10 text-gray-400 px-6">
                        <i class="fa-solid fa-store-slash text-4xl mb-3"></i>
                        <p>é€™é™„è¿‘ ${currentRadius} å…¬å°ºå…§æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„åº—å®¶...</p>
                        <p class="text-sm mt-2">è©¦è©¦çœ‹æ‹‰å¤§æœå°‹ç¯„åœï¼Ÿ</p>
                        <button onclick="openGoogleSearchFallback()" class="mt-6 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg text-sm font-semibold">ç›´æ¥ Google Maps æœå°‹</button>
                    </div>
                `;
                return;
            }

            fabContainer.classList.remove('hidden');
            
            const infoDiv = document.createElement('div');
            infoDiv.className = "px-4 py-2 text-xs text-gray-500 flex justify-between items-center";
            infoDiv.innerHTML = `<span>æ‰¾åˆ° ${shopsData.length} é–“åº—å®¶</span> <span onclick="openGoogleSearchFallback()" class="text-blue-500 underline cursor-pointer">Google Maps æœå°‹</span>`;
            resultsList.appendChild(infoDiv);

            shopsData.forEach(shop => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl shadow-sm mx-4 flex justify-between items-center card-anim cursor-pointer border-l-4 border-transparent hover:border-orange-400 mb-3';
                
                let iconClass = 'fa-utensils';
                let iconColor = 'text-orange-400';
                
                // Smart Icon Logic
                const t = JSON.stringify(shop.tags).toLowerCase();
                if (currentMode === 'drinks' || t.includes('tea') || t.includes('beverage') || t.includes('cafe')) { 
                    iconClass = 'fa-mug-saucer'; iconColor = 'text-teal-500'; 
                }
                else if (currentMode === 'date') { iconClass = 'fa-heart'; iconColor = 'text-pink-400'; }
                else if (t.includes('burger') || t.includes('fast_food')) { iconClass = 'fa-burger'; iconColor = 'text-yellow-500'; }
                else if (t.includes('japanese') || t.includes('sushi')) { iconClass = 'fa-fish'; iconColor = 'text-red-400'; }
                else if (t.includes('noodle') || t.includes('ramen')) { iconClass = 'fa-bowl-food'; iconColor = 'text-yellow-600'; }
                
                card.innerHTML = `
                    <div class="flex items-center overflow-hidden">
                        <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center flex-shrink-0 mr-3">
                            <i class="fa-solid ${iconClass} ${iconColor}"></i>
                        </div>
                        <div class="min-w-0">
                            <h3 class="font-bold text-gray-800 truncate text-base">${shop.name}</h3>
                            <p class="text-xs text-gray-500 truncate">
                                <i class="fa-solid fa-location-dot text-gray-300"></i> ${shop.distanceM < 1000 ? shop.distanceM + ' m' : shop.distance + ' km'} 
                                <span class="mx-1">â€¢</span> ${translateType(shop.type)}
                            </p>
                        </div>
                    </div>
                    <div class="flex-shrink-0 ml-2">
                         <i class="fa-solid fa-chevron-right text-gray-300 text-sm"></i>
                    </div>
                `;
                card.onclick = () => {
                    selectedShop = shop;
                    updateModalUI();
                    openModal();
                };
                resultsList.appendChild(card);
            });
            
            const spacer = document.createElement('div');
            spacer.className = 'h-20';
            resultsList.appendChild(spacer);
        }

        // --- Logic: Selection & History ---

        function pickRandom() {
            if (shopsData.length === 0) return;
            const randIndex = Math.floor(Math.random() * shopsData.length);
            selectedShop = shopsData[randIndex];
            updateModalUI();
            openModal();
        }

        function updateModalUI() {
            document.getElementById('modal-shop-name').innerText = selectedShop.name;
            document.getElementById('modal-shop-type').innerText = translateType(selectedShop.type);
        }

        function openModal() {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function saveToHistoryAndClose() {
            if (!selectedShop) return;
            const record = {
                name: selectedShop.name,
                date: new Date().toLocaleDateString('zh-TW'),
                timestamp: Date.now(),
                type: translateType(selectedShop.type)
            };
            historyData.unshift(record);
            localStorage.setItem('foodHistory', JSON.stringify(historyData));

            Swal.fire({
                icon: 'success',
                title: 'ç´€éŒ„æˆåŠŸï¼',
                text: `å·²ç´€éŒ„ä»Šå¤©åƒã€Œ${selectedShop.name}ã€`,
                timer: 1500,
                showConfirmButton: false,
                confirmButtonColor: '#F97316'
            });
            closeModal();
        }

        // --- History Modal Logic ---
        function openHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            
            if (historyData.length === 0) {
                list.innerHTML = `
                    <div class="text-center text-gray-400 mt-10">
                        <i class="fa-solid fa-cookie-bite text-4xl mb-2"></i>
                        <p>é‚„æ²’æœ‰ç´€éŒ„å–”ï¼Œå¿«å»åƒé»å¥½æ–™ï¼</p>
                    </div>
                `;
            } else {
                historyData.forEach((item, index) => {
                    const el = document.createElement('div');
                    el.className = "flex justify-between items-center border-b border-gray-100 py-3";
                    el.innerHTML = `
                        <div>
                            <div class="text-xs text-gray-400 mb-1">${item.date}</div>
                            <div class="font-bold text-gray-800">${item.name}</div>
                            <div class="text-xs text-gray-500 bg-gray-100 inline-block px-2 rounded-full mt-1">${item.type}</div>
                        </div>
                        <button onclick="deleteHistoryItem(${index})" class="text-gray-300 hover:text-red-500 px-2">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    `;
                    list.appendChild(el);
                });
            }
            historyModal.classList.remove('hidden', 'translate-y-full');
            historyModal.classList.add('translate-y-0');
        }

        function closeHistory() {
            historyModal.classList.add('translate-y-full');
            setTimeout(() => {
                historyModal.classList.add('hidden');
            }, 300);
        }

        function deleteHistoryItem(index) {
            historyData.splice(index, 1);
            localStorage.setItem('foodHistory', JSON.stringify(historyData));
            openHistory();
        }

        function clearHistory() {
            if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç´€éŒ„å—ï¼Ÿ")) {
                historyData = [];
                localStorage.setItem('foodHistory', JSON.stringify(historyData));
                openHistory();
            }
        }

        // --- Navigation ---
        function openGoogleMapsFromModal() {
            if(selectedShop) {
                const query = encodeURIComponent(selectedShop.name);
                // Try to guide map to exact lat/lon
                const url = `https://www.google.com/maps/search/?api=1&query=${query}&query_place_id=${selectedShop.lat},${selectedShop.lon}`;
                window.open(url, '_blank');
            }
        }

        function openGoogleSearchFallback() {
            let keyword = "ç¾é£Ÿ";
            if (currentMode === 'date') keyword = "æ°£æ°›å¥½çš„é¤å»³ ç”œé»";
            if (currentMode === 'drinks') keyword = "æ‰‹æ–é£²æ–™";
            const url = `https://www.google.com/maps/search/${keyword}/@${currentUserLocation.lat},${currentUserLocation.lng},15z/data=!3m1!4b1`;
            window.open(url, '_blank');
        }

        // --- Helpers ---
        function translateType(type) {
            const dict = {
                'restaurant': 'é¤å»³', 'fast_food': 'é€Ÿé£Ÿ', 'cafe': 'å’–å•¡å»³', 'ice_cream': 'å†°æ·‡æ·‹',
                'noodle': 'éºµåº—', 'japanese': 'æ—¥å¼æ–™ç†', 'burger': 'æ¼¢å ¡', 'pizza': 'æŠ«è–©',
                'coffee_shop': 'å’–å•¡åº—', 'tea': 'èŒ¶é£²', 'bubble_tea': 'çå¥¶', 'beverage': 'é£²æ–™åº—'
            };
            return dict[type] || 'åº—å®¶';
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; 
            var dLat = deg2rad(lat2-lat1);  
            var dLon = deg2rad(lon2-lon1); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c; 
        }

        function deg2rad(deg) { return deg * (Math.PI/180); }

        function showError(text) {
            const errDiv = document.getElementById('error-msg');
            document.getElementById('error-text').innerText = text;
            errDiv.classList.remove('hidden');
            setTimeout(() => { errDiv.classList.add('hidden'); }, 3000);
        }
    </script>
</body>
</html>

