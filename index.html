<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šå¤©åƒä»€éº¼ï¼Ÿ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F3F4F6;
            -webkit-tap-highlight-color: transparent;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #F59E0B;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card-anim {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-anim:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white shadow-sm z-10 p-4 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-utensils text-orange-500 mr-2"></i>ä»Šå¤©åƒä»€éº¼</h1>
            <p class="text-xs text-gray-500">Hi Oliverï¼Œé¤“äº†å—ï¼Ÿ</p>
        </div>
        <div id="status-badge" class="hidden px-2 py-1 rounded-full text-xs font-semibold bg-gray-200 text-gray-600">
            å®šä½ä¸­...
        </div>
    </header>

    <!-- Filter / Controls -->
    <div class="p-4 bg-white border-b border-gray-200 flex gap-2 overflow-x-auto whitespace-nowrap scrollbar-hide">
        <button onclick="setMode('all')" id="btn-all" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-orange-500 text-white shadow-md transition">
            å…¨éƒ¨é¤å»³
        </button>
        <button onclick="setMode('date')" id="btn-date" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition">
            ğŸ’• æ£ æ£ ç´„æœƒæ¨¡å¼
        </button>
        <button onclick="setMode('noodle')" id="btn-noodle" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition">
            ğŸœ éºµé£Ÿ
        </button>
    </div>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto p-4 relative" id="main-container">
        
        <!-- Empty State / Start Screen -->
        <div id="start-screen" class="flex flex-col items-center justify-center h-full text-center space-y-6">
            <div class="w-32 h-32 bg-orange-100 rounded-full flex items-center justify-center animate-bounce">
                <i class="fa-solid fa-location-dot text-5xl text-orange-500"></i>
            </div>
            <div>
                <h2 class="text-xl font-bold text-gray-800">æœå°‹é™„è¿‘çš„ç¾å‘³</h2>
                <p class="text-gray-500 mt-2 text-sm">æˆ‘å€‘æœƒæœå°‹æ‚¨å‘¨åœ 1 å…¬é‡Œå…§çš„åº—å®¶</p>
            </div>
            <button onclick="getLocation()" class="bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg transform transition hover:scale-105 active:scale-95 flex items-center">
                <i class="fa-solid fa-magnifying-glass-location mr-2"></i> é–‹å§‹æœå°‹
            </button>
        </div>

        <!-- Loading State -->
        <div id="loading-screen" class="hidden flex flex-col items-center justify-center h-full">
            <div class="loader mb-4"></div>
            <p class="text-gray-600 font-medium">æ­£åœ¨æƒæå‘¨åœåº—å®¶...</p>
            <p class="text-gray-400 text-xs mt-2">ä½¿ç”¨ OpenStreetMap è³‡æ–™åº«</p>
        </div>

        <!-- Results List -->
        <div id="results-list" class="hidden pb-20 space-y-3">
            <!-- Items will be injected here -->
        </div>

    </main>

    <!-- Floating Action Button (Random Picker) -->
    <div id="fab-container" class="hidden absolute bottom-6 right-6 z-20">
        <button onclick="pickRandom()" class="bg-gray-800 text-white w-16 h-16 rounded-full shadow-xl flex items-center justify-center text-2xl hover:bg-gray-700 transition transform hover:rotate-12 active:scale-90">
            <i class="fa-solid fa-dice"></i>
        </button>
    </div>

    <!-- Result Modal (Random Pick) -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl transform transition-all scale-95 opacity-0" id="modal-content">
            <div class="text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-check text-2xl text-green-600"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-400 mb-1">æ±ºå®šå°±æ˜¯é€™å®¶äº†ï¼</h3>
                <h2 id="modal-shop-name" class="text-2xl font-black text-gray-800 mb-2 leading-tight">åº—å®¶åç¨±</h2>
                <p id="modal-shop-type" class="text-sm text-gray-500 mb-6 bg-gray-100 inline-block px-3 py-1 rounded-full">é¡å‹</p>
                
                <div class="flex gap-3">
                    <button onclick="closeModal()" class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition">
                        å†é¸ä¸€æ¬¡
                    </button>
                    <button onclick="openGoogleMapsFromModal()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700 transition flex items-center justify-center">
                        <i class="fa-solid fa-diamond-turn-right mr-2"></i> å»å°èˆª
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- No Results / Error State -->
    <div id="error-msg" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 bg-red-100 text-red-700 px-4 py-2 rounded-lg shadow-md text-sm whitespace-nowrap z-50">
        <i class="fa-solid fa-circle-exclamation mr-1"></i> <span id="error-text">ç™¼ç”ŸéŒ¯èª¤</span>
    </div>

    <script>
        let currentUserLocation = null;
        let shopsData = [];
        let currentMode = 'all'; // all, date, noodle
        let selectedShop = null;

        const statusBadge = document.getElementById('status-badge');
        const startScreen = document.getElementById('start-screen');
        const loadingScreen = document.getElementById('loading-screen');
        const resultsList = document.getElementById('results-list');
        const fabContainer = document.getElementById('fab-container');
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');

        // Personalization for Chenchen & Tangtang
        const modes = {
            'all': {
                query: `["amenity"~"restaurant|fast_food|food_court"]`,
                color: 'bg-orange-500',
                icon: 'fa-utensils'
            },
            'date': {
                // Focus on cafes, ice cream, sweeter things or nice restaurants
                query: `["amenity"~"cafe|ice_cream"]`, 
                color: 'bg-pink-500',
                icon: 'fa-heart'
            },
            'noodle': {
                // Generic restaurant but we will filter names later or just general food
                query: `["cuisine"~"noodle|ramen|japanese"]`,
                fallbackQuery: `["amenity"="restaurant"]`, // Fallback
                color: 'bg-yellow-600',
                icon: 'fa-bowl-food'
            }
        };

        function setMode(mode) {
            currentMode = mode;
            
            // Update UI buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-orange-500', 'bg-pink-500', 'bg-yellow-600', 'text-white', 'shadow-md');
                btn.classList.add('bg-gray-100', 'text-gray-600');
            });

            const activeBtn = document.getElementById(`btn-${mode}`);
            activeBtn.classList.remove('bg-gray-100', 'text-gray-600');
            activeBtn.classList.add(modes[mode].color, 'text-white', 'shadow-md');

            // If we already have location, re-fetch
            if (currentUserLocation) {
                fetchShops(currentUserLocation.lat, currentUserLocation.lng);
            }
        }

        function getLocation() {
            if (!navigator.geolocation) {
                showError("ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½");
                return;
            }

            statusBadge.classList.remove('hidden');
            statusBadge.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> å®šä½ä¸­...';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentUserLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    statusBadge.innerHTML = '<i class="fa-solid fa-location-arrow text-green-600 mr-1"></i> å®šä½æˆåŠŸ';
                    statusBadge.classList.add('bg-green-100', 'text-green-800');
                    fetchShops(currentUserLocation.lat, currentUserLocation.lng);
                },
                (error) => {
                    let msg = "ç„¡æ³•ç²å–ä½ç½®";
                    if (error.code === 1) msg = "è«‹å…è¨±ä½ç½®å­˜å–æ¬Šé™";
                    showError(msg);
                    statusBadge.innerHTML = 'å®šä½å¤±æ•—';
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        async function fetchShops(lat, lng) {
            startScreen.classList.add('hidden');
            loadingScreen.classList.remove('hidden');
            resultsList.classList.add('hidden');
            fabContainer.classList.add('hidden');

            try {
                // Using Overpass API (OpenStreetMap) to avoid Google API Key requirement
                // Searching within 1000m radius
                let queryTag = modes[currentMode].query;
                
                // Construct Overpass QL
                // Requesting json output, timeout 25s
                const query = `
                    [out:json][timeout:25];
                    (
                      node(around:1000,${lat},${lng})${queryTag};
                      way(around:1000,${lat},${lng})${queryTag};
                    );
                    out center;
                `;

                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });

                if (!response.ok) throw new Error("API Error");

                const data = await response.json();
                processResults(data.elements);

            } catch (err) {
                console.error(err);
                showError("ç„¡æ³•å–å¾—åº—å®¶è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦");
                loadingScreen.classList.add('hidden');
                startScreen.classList.remove('hidden');
            }
        }

        function processResults(elements) {
            shopsData = elements.filter(el => el.tags && el.tags.name).map(el => {
                const lat = el.lat || el.center.lat;
                const lon = el.lon || el.center.lon;
                // Calculate rough distance
                const dist = getDistanceFromLatLonInKm(currentUserLocation.lat, currentUserLocation.lng, lat, lon);
                return {
                    id: el.id,
                    name: el.tags.name,
                    type: el.tags.cuisine || el.tags.amenity || 'é¤å»³',
                    lat: lat,
                    lon: lon,
                    distance: dist.toFixed(2),
                    tags: el.tags
                };
            }).sort((a, b) => a.distance - b.distance); // Sort by distance

            renderList();
        }

        function renderList() {
            loadingScreen.classList.add('hidden');
            resultsList.classList.remove('hidden');
            resultsList.innerHTML = '';

            if (shopsData.length === 0) {
                resultsList.innerHTML = `
                    <div class="text-center mt-10 text-gray-400">
                        <i class="fa-solid fa-store-slash text-4xl mb-3"></i>
                        <p>é€™é™„è¿‘ 1 å…¬é‡Œå…§ä¼¼ä¹æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„åº—å®¶...</p>
                        <button onclick="openGoogleSearchFallback()" class="mt-4 text-blue-500 underline">ç›´æ¥åœ¨ Google Maps é–‹å•Ÿæœå°‹</button>
                    </div>
                `;
                return;
            }

            fabContainer.classList.remove('hidden');
            
            // Add a header for direct google map search
            const fallbackBtn = document.createElement('div');
            fallbackBtn.className = 'px-4 pt-2 pb-2';
            fallbackBtn.innerHTML = `
                <button onclick="openGoogleSearchFallback()" class="w-full bg-white border border-blue-200 text-blue-600 py-2 rounded-lg text-sm font-semibold shadow-sm hover:bg-blue-50 transition">
                    <i class="fa-brands fa-google"></i> åœ¨ Google Maps ä¸ŠæŸ¥çœ‹æ‰€æœ‰ç‡Ÿæ¥­ä¸­åº—å®¶
                </button>
            `;
            resultsList.appendChild(fallbackBtn);

            shopsData.forEach(shop => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl shadow-sm mx-4 flex justify-between items-center card-anim cursor-pointer border-l-4 border-transparent hover:border-orange-400';
                
                // Icon selection
                let iconClass = 'fa-utensils';
                let iconColor = 'text-orange-400';
                if (shop.tags.amenity === 'cafe') { iconClass = 'fa-mug-hot'; iconColor = 'text-pink-400'; }
                if (shop.tags.cuisine === 'burger') { iconClass = 'fa-burger'; }
                
                card.innerHTML = `
                    <div class="flex items-center overflow-hidden">
                        <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center flex-shrink-0 mr-3">
                            <i class="fa-solid ${iconClass} ${iconColor}"></i>
                        </div>
                        <div class="min-w-0">
                            <h3 class="font-bold text-gray-800 truncate text-base">${shop.name}</h3>
                            <p class="text-xs text-gray-500 truncate">
                                <i class="fa-solid fa-location-dot text-gray-300"></i> ${shop.distance} km 
                                <span class="mx-1">â€¢</span> ${translateType(shop.type)}
                            </p>
                        </div>
                    </div>
                    <div class="flex-shrink-0 ml-2">
                         <i class="fa-solid fa-chevron-right text-gray-300 text-sm"></i>
                    </div>
                `;
                card.onclick = () => openGoogleMap(shop);
                resultsList.appendChild(card);
            });
            
            // Add extra space at bottom for FAB
            const spacer = document.createElement('div');
            spacer.className = 'h-16';
            resultsList.appendChild(spacer);
        }

        // --- Helper Functions ---

        function translateType(type) {
            const dict = {
                'restaurant': 'é¤å»³', 'fast_food': 'é€Ÿé£Ÿ', 'cafe': 'å’–å•¡å»³', 'ice_cream': 'å†°æ·‡æ·‹',
                'noodle': 'éºµåº—', 'japanese': 'æ—¥å¼æ–™ç†', 'burger': 'æ¼¢å ¡', 'pizza': 'æŠ«è–©',
                'coffee_shop': 'å’–å•¡åº—', 'food_court': 'ç¾é£Ÿè¡—'
            };
            return dict[type] || type;
        }

        function pickRandom() {
            if (shopsData.length === 0) return;
            
            const randIndex = Math.floor(Math.random() * shopsData.length);
            selectedShop = shopsData[randIndex];
            
            document.getElementById('modal-shop-name').innerText = selectedShop.name;
            document.getElementById('modal-shop-type').innerText = translateType(selectedShop.type);
            
            modal.classList.remove('hidden');
            // Animation for modal content
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // Direct link to specific shop coordinates
        function openGoogleMap(shop) {
            // Using query with coordinates ensures marker drops at right place
            // Adding "open now" is tricky with direct marker, but we assume user checks
            const query = encodeURIComponent(shop.name);
            const url = `https://www.google.com/maps/search/?api=1&query=${query}&query_place_id=${shop.lat},${shop.lon}`;
            window.open(url, '_blank');
        }

        function openGoogleMapsFromModal() {
            if(selectedShop) openGoogleMap(selectedShop);
        }

        // Fallback: Opens a general search in Google Maps with "Open Now" implied by user action
        // Note: Google Maps URL scheme supports 'query' but explicit "open now" filter via URL 
        // is not officially documented for standard web intents reliably across all devices,
        // but searching "Open restaurants near me" usually works.
        function openGoogleSearchFallback() {
            let keyword = "ç¾é£Ÿ";
            if (currentMode === 'date') keyword = "æ°£æ°›å¥½çš„é¤å»³ å’–å•¡å»³";
            if (currentMode === 'noodle') keyword = "éºµåº—";

            const url = `https://www.google.com/maps/search/${keyword}/@${currentUserLocation.lat},${currentUserLocation.lng},15z/data=!3m1!4b1`;
            window.open(url, '_blank');
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; 
            var dLat = deg2rad(lat2-lat1);  
            var dLon = deg2rad(lon2-lon1); 
            var a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            var d = R * c; 
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }

        function showError(text) {
            const errDiv = document.getElementById('error-msg');
            document.getElementById('error-text').innerText = text;
            errDiv.classList.remove('hidden');
            setTimeout(() => {
                errDiv.classList.add('hidden');
            }, 3000);
        }
    </script>
</body>
</html>

